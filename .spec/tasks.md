# DeliverOrderBundle TDD 任务分解

## 任务概览

本文档将 DeliverOrderBundle 的实现分解为具体的 TDD 任务。每个任务遵循红-绿-重构循环，确保代码质量和测试覆盖率。

---

## 基础架构任务

## 任务 1: Bundle 基础结构和配置

### 描述
创建 Bundle 的基础结构，包括目录结构、composer.json 配置、Bundle 主类和基础配置文件。

### 验收标准（基于 EARS）
- 系统必须提供标准的 Symfony Bundle 结构
- 系统必须支持 Symfony 6.4+ 的自动加载
- 系统必须通过 composer 正确加载包

### TDD 实施步骤
1. **红色阶段**：编写测试验证 Bundle 可以被 Symfony 加载
2. **绿色阶段**：创建 DeliverOrderBundle.php 和基础配置
3. **重构阶段**：优化目录结构和命名空间

### 测试场景
- 单元测试：Bundle 类可以实例化
- 集成测试：Bundle 可以注册到 Symfony 容器
- 边缘案例：处理配置文件不存在的情况

### 依赖关系
- 需要：无
- 阻塞：所有其他任务

---

## 任务 2: 异常类定义

### 描述
创建包的异常类体系，包括基础异常类和特定业务异常类。

### 验收标准（基于 EARS）
- 系统必须提供 DeliverException 基础异常类
- 系统必须提供 InvalidSourceException 处理无效来源
- 系统必须提供 InsufficientStockException 处理库存不足

### TDD 实施步骤
1. **红色阶段**：编写测试验证异常类的继承关系和消息
2. **绿色阶段**：实现异常类及其构造函数
3. **重构阶段**：添加错误码和上下文信息支持

### 测试场景
- 单元测试：异常类可以正确抛出和捕获
- 单元测试：异常消息格式化正确
- 边缘案例：异常链的正确传递

### 依赖关系
- 需要：任务 1
- 阻塞：任务 7, 8

---

## 实体和数据模型任务

## 任务 3: DeliverOrder 实体（贫血模型）

### 描述
创建 DeliverOrder 实体类，仅包含属性和 getter/setter 方法，不包含业务逻辑。

### 验收标准（基于 EARS）
- 系统必须提供 DeliverOrder 实体来管理发货单信息
- 系统必须支持发货单号的唯一性
- 系统必须记录发货单的快递信息
- 系统必须记录收货人信息
- 当处于已发货状态时，系统必须记录发货时间和操作人
- 当处于已收货状态时，系统必须记录收货时间和用户
- 当处于已拒收状态时，系统必须记录拒收时间、原因和用户

### TDD 实施步骤
1. **红色阶段**：编写测试验证实体属性的 getter/setter
2. **绿色阶段**：实现实体类和 Doctrine 映射
3. **重构阶段**：优化属性类型和验证注解

### 测试场景
- 单元测试：所有属性的 getter/setter 工作正常
- 单元测试：Doctrine 映射正确配置
- 单元测试：Collection 关联正确初始化
- 边缘案例：null 值的处理

### 依赖关系
- 需要：任务 1
- 阻塞：任务 5, 6, 9

---

## 任务 4: DeliverStock 实体（贫血模型）

### 描述
创建 DeliverStock 实体类，管理发货明细信息。

### 验收标准（基于 EARS）
- 系统必须提供 DeliverStock 实体来管理发货明细
- 系统必须支持记录 SKU 信息、数量、序列号等
- 如果启用批次管理，系统必须记录批次信息
- 如果启用序列号管理，系统必须记录产品序列号

### TDD 实施步骤
1. **红色阶段**：编写测试验证实体属性和关联关系
2. **绿色阶段**：实现实体类和 Doctrine 映射
3. **重构阶段**：优化与 DeliverOrder 的双向关联

### 测试场景
- 单元测试：所有属性的 getter/setter 工作正常
- 单元测试：与 DeliverOrder 的关联正确
- 边缘案例：数量为 0 或负数的验证

### 依赖关系
- 需要：任务 3
- 阻塞：任务 5, 6, 9

---

## 任务 5: DeliverContext 数据传输对象

### 描述
创建 DeliverContext 类，用于在服务之间传递发货上下文数据。

### 验收标准（基于 EARS）
- 系统必须提供 DeliverContext 类管理发货上下文
- 系统必须在上下文中保存来源信息、业务数据等
- 如果来源是订单，系统必须验证订单状态允许发货
- 如果来源是售后单，系统必须验证售后状态允许换货

### TDD 实施步骤
1. **红色阶段**：编写测试验证上下文数据的存取
2. **绿色阶段**：实现 DeliverContext 类
3. **重构阶段**：添加数据验证和类型提示

### 测试场景
- 单元测试：上下文数据的设置和获取
- 单元测试：必需字段的验证
- 边缘案例：空数组和无效数据的处理

### 依赖关系
- 需要：任务 1
- 阻塞：任务 7, 8, 9, 10

---

## Repository 任务

## 任务 6: Repository 实现

### 描述
创建 DeliverOrderRepository 和 DeliverStockRepository，提供数据访问层。

### 验收标准（基于 EARS）
- 系统必须提供查询发货单的方法 findDeliverOrder(string $sn)
- 系统必须支持按来源查询发货单
- 系统必须支持按状态统计发货单

### TDD 实施步骤
1. **红色阶段**：编写测试验证查询方法的返回值
2. **绿色阶段**：实现 Repository 类继承 ServiceEntityRepository
3. **重构阶段**：添加查询优化和索引提示

### 测试场景
- 集成测试：findOneBySn 正确返回发货单
- 集成测试：findBySource 返回正确的结果集
- 集成测试：countByStatus 返回正确的统计
- 边缘案例：查询不存在的记录返回 null

### 依赖关系
- 需要：任务 3, 4
- 阻塞：任务 9

---

## 接口定义任务

## 任务 7: 核心服务接口定义

### 描述
定义 DeliverOrderServiceInterface 和 DeliverSourceInterface 等核心接口。

### 验收标准（基于 EARS）
- 系统必须提供 DeliverOrderServiceInterface 服务接口
- 系统必须提供 DeliverSourceInterface 接口定义发货单来源
- 系统必须提供创建发货单的方法 createDeliverOrder(DeliverContext $context)

### TDD 实施步骤
1. **红色阶段**：编写测试验证接口方法签名
2. **绿色阶段**：创建接口定义
3. **重构阶段**：优化方法参数和返回类型

### 测试场景
- 单元测试：接口可以被正确实现
- 单元测试：方法签名符合 PSR 标准
- 边缘案例：接口的多重实现

### 依赖关系
- 需要：任务 1, 5
- 阻塞：任务 9, 13, 14

---

## 任务 8: 扩展接口定义

### 描述
定义 DeliverValidatorInterface 和 DeliverProcessorInterface 扩展接口。

### 验收标准（基于 EARS）
- 系统必须提供 DeliverValidatorInterface 验证器接口
- 系统必须提供 DeliverProcessorInterface 处理器接口
- 系统必须支持自定义验证规则
- 系统必须支持自定义业务处理逻辑

### TDD 实施步骤
1. **红色阶段**：编写测试验证接口的扩展性
2. **绿色阶段**：创建扩展接口定义
3. **重构阶段**：添加 supports 和 getPriority 方法

### 测试场景
- 单元测试：验证器接口的实现
- 单元测试：处理器接口的优先级排序
- 边缘案例：空验证器和处理器的处理

### 依赖关系
- 需要：任务 1, 5
- 阻塞：任务 10, 11, 17, 18

---

## 核心服务实现任务

## 任务 9: DeliverOrderService 核心服务

### 描述
实现 DeliverOrderService 类，处理发货单的核心业务逻辑。

### 验收标准（基于 EARS）
- 当触发发货操作时，系统必须创建发货单
- 当发货单创建时，系统必须触发 DeliverOrderCreatedEvent 事件
- 系统必须支持部分发货和完全发货
- 当确认收货时，系统必须更新发货单状态为已收货
- 当发生拒收时，系统必须更新发货单状态为已拒收

### TDD 实施步骤
1. **红色阶段**：编写测试验证 createDeliverOrder 方法
2. **绿色阶段**：实现核心业务方法
3. **重构阶段**：抽取私有方法，优化代码结构

### 测试场景
- 单元测试：createDeliverOrder 创建并返回发货单
- 单元测试：ship 方法更新快递信息
- 单元测试：receive 方法更新收货状态
- 单元测试：reject 方法记录拒收原因
- 集成测试：完整的发货流程
- 边缘案例：重复发货单号的处理

### 依赖关系
- 需要：任务 3, 4, 5, 6, 7
- 阻塞：任务 19

---

## 任务 10: DeliverValidationService 验证服务

### 描述
实现 DeliverValidationService，处理发货前的各种验证逻辑。

### 验收标准（基于 EARS）
- 当创建发货明细时，系统必须验证 SKU 的有效性
- 当执行发货前，系统必须调用所有注册的验证器
- 系统必须验证来源的有效性

### TDD 实施步骤
1. **红色阶段**：编写测试验证基础验证逻辑
2. **绿色阶段**：实现 validate 和 validateBasic 方法
3. **重构阶段**：实现验证器注册机制

### 测试场景
- 单元测试：validateBasic 验证必需字段
- 单元测试：addValidator 正确注册验证器
- 单元测试：validate 调用所有验证器
- 边缘案例：空来源信息抛出异常
- 边缘案例：数量为 0 或负数抛出异常

### 依赖关系
- 需要：任务 2, 5, 8
- 阻塞：任务 9

---

## 任务 11: DeliverProcessorService 处理器服务

### 描述
实现 DeliverProcessorService，管理和执行发货相关的业务处理器。

### 验收标准（基于 EARS）
- 系统必须支持自定义业务处理逻辑
- 在配置处理器链的情况下，系统必须按顺序执行处理器
- 如果配置了库存管理，系统必须扣减库存

### TDD 实施步骤
1. **红色阶段**：编写测试验证处理器的注册和执行
2. **绿色阶段**：实现 addProcessor 和 process 方法
3. **重构阶段**：添加优先级排序逻辑

### 测试场景
- 单元测试：addProcessor 正确注册处理器
- 单元测试：process 按顺序执行所有处理器
- 单元测试：处理器的 supports 方法正确过滤
- 边缘案例：空处理器列表的处理

### 依赖关系
- 需要：任务 8
- 阻塞：任务 9

---

## 任务 12: DeliverContextService 上下文服务

### 描述
实现 DeliverContextService，管理发货上下文数据的创建和转换。

### 验收标准（基于 EARS）
- 系统必须提供创建发货上下文的方法
- 系统必须正确映射数组数据到上下文对象
- 系统必须验证上下文数据的完整性

### TDD 实施步骤
1. **红色阶段**：编写测试验证 createContext 方法
2. **绿色阶段**：实现数据映射逻辑
3. **重构阶段**：添加数据验证和默认值处理

### 测试场景
- 单元测试：createContext 正确创建上下文
- 单元测试：处理缺失的可选字段
- 边缘案例：空数组的处理
- 边缘案例：无效数据类型的处理

### 依赖关系
- 需要：任务 5
- 阻塞：任务 9

---

## 事件系统任务

## 任务 13: 事件类实现

### 描述
创建所有事件类，包括 DeliverOrderCreatedEvent、DeliverOrderShippedEvent 等。

### 验收标准（基于 EARS）
- 当发货单创建时，系统必须触发 DeliverOrderCreatedEvent 事件
- 当收货完成时，系统必须触发 DeliverOrderReceivedEvent 事件
- 当拒收发生时，系统必须触发 DeliverOrderRejectedEvent 事件

### TDD 实施步骤
1. **红色阶段**：编写测试验证事件类的属性和方法
2. **绿色阶段**：实现事件类
3. **重构阶段**：添加事件基类减少重复代码

### 测试场景
- 单元测试：事件类可以正确实例化
- 单元测试：事件携带正确的数据
- 边缘案例：事件的不可变性

### 依赖关系
- 需要：任务 3, 5
- 阻塞：任务 14, 9

---

## 任务 14: 事件订阅者实现

### 描述
创建 DeliverOrderEventSubscriber，处理发货单相关事件。

### 验收标准（基于 EARS）
- 系统必须提供标准的事件接口供外部监听
- 系统必须支持事件订阅者扩展
- 在启用异步处理的情况下，系统必须支持异步事件处理

### TDD 实施步骤
1. **红色阶段**：编写测试验证事件订阅配置
2. **绿色阶段**：实现 getSubscribedEvents 方法
3. **重构阶段**：添加事件处理方法

### 测试场景
- 单元测试：订阅者正确注册事件
- 集成测试：事件触发时订阅者被调用
- 边缘案例：异常处理不影响其他订阅者

### 依赖关系
- 需要：任务 13
- 阻塞：无

---

## 配置和集成任务

## 任务 15: Symfony 服务配置

### 描述
创建 services.php 配置文件，配置依赖注入和服务标签。

### 验收标准（基于 EARS）
- 系统必须提供标准的 Symfony Bundle 结构
- 系统必须支持 Symfony 的依赖注入容器
- 系统必须提供配置文件支持

### TDD 实施步骤
1. **红色阶段**：编写测试验证服务注册
2. **绿色阶段**：创建 services.php 配置
3. **重构阶段**：优化服务标签和别名

### 测试场景
- 集成测试：服务可以从容器获取
- 集成测试：接口别名正确配置
- 集成测试：标签服务正确注入
- 边缘案例：循环依赖检测

### 依赖关系
- 需要：任务 1, 7, 8, 9, 10, 11
- 阻塞：任务 19

---

## 任务 16: Doctrine 迁移脚本

### 描述
通过 Doctrine 实体自动生成数据库迁移脚本。

### 验收标准（基于 EARS）
- 系统必须使用 Doctrine ORM 进行数据持久化
- 系统必须提供数据库迁移脚本
- 系统必须支持多数据库连接配置

### TDD 实施步骤
1. **红色阶段**：编写测试验证数据库结构
2. **绿色阶段**：生成并验证迁移脚本
3. **重构阶段**：优化索引和外键约束

### 测试场景
- 集成测试：迁移脚本可以正确执行
- 集成测试：回滚脚本可以正确执行
- 边缘案例：重复执行迁移的幂等性

### 依赖关系
- 需要：任务 3, 4
- 阻塞：任务 19

---

## 扩展机制任务

## 任务 17: 自定义验证器示例

### 描述
创建 OrderSourceValidator 作为自定义验证器的示例实现。

### 验收标准（基于 EARS）
- 系统必须支持自定义验证规则
- 如果来源是订单，系统必须验证订单状态允许发货
- 在配置启用的情况下，系统必须验证来源的有效性

### TDD 实施步骤
1. **红色阶段**：编写测试验证验证器逻辑
2. **绿色阶段**：实现 OrderSourceValidator
3. **重构阶段**：添加配置支持

### 测试场景
- 单元测试：validate 方法验证订单状态
- 单元测试：supports 方法正确判断来源类型
- 边缘案例：订单不存在抛出异常
- 边缘案例：订单状态不允许发货抛出异常

### 依赖关系
- 需要：任务 8, 10
- 阻塞：无

---

## 任务 18: 自定义处理器示例

### 描述
创建 StockDeductionProcessor 作为自定义处理器的示例实现。

### 验收标准（基于 EARS）
- 系统必须支持自定义业务处理逻辑
- 如果配置了库存管理，系统必须扣减库存
- 如果配置了库存管理，系统必须恢复库存（拒收时）

### TDD 实施步骤
1. **红色阶段**：编写测试验证库存扣减逻辑
2. **绿色阶段**：实现 StockDeductionProcessor
3. **重构阶段**：添加批次和序列号支持

### 测试场景
- 单元测试：process 方法正确扣减库存
- 单元测试：supports 方法读取环境变量
- 单元测试：getPriority 返回正确优先级
- 边缘案例：库存不足的处理

### 依赖关系
- 需要：任务 8, 11
- 阻塞：无

---

## 测试和文档任务

## 任务 19: 集成测试套件

### 描述
创建完整的集成测试套件，测试整个发货流程。

### 验收标准（基于 EARS）
- 系统必须达到 90% 以上的单元测试覆盖率
- 系统必须提供完整的集成测试
- 系统必须通过 PHPStan Level 8 检查

### TDD 实施步骤
1. **红色阶段**：编写端到端的集成测试
2. **绿色阶段**：确保所有测试通过
3. **重构阶段**：添加性能测试和压力测试

### 测试场景
- 集成测试：完整的创建发货单流程
- 集成测试：发货-收货流程
- 集成测试：发货-拒收流程
- 集成测试：事件订阅者集成
- 性能测试：批量创建发货单
- 边缘案例：并发创建的处理

### 依赖关系
- 需要：任务 1-18
- 阻塞：任务 20

---

## 任务 20: README 和使用文档

### 描述
创建 README.md 文件，提供安装指南、使用示例和 API 文档。

### 验收标准（基于 EARS）
- 系统必须提供完整的 API 文档
- 系统必须提供使用示例和最佳实践
- 系统必须提供升级指南

### TDD 实施步骤
1. **红色阶段**：列出所有需要文档化的内容
2. **绿色阶段**：编写基础文档
3. **重构阶段**：添加代码示例和图表

### 测试场景
- 文档测试：所有代码示例可以运行
- 文档测试：API 文档与实际接口一致
- 边缘案例：错误示例的说明

### 依赖关系
- 需要：任务 1-19
- 阻塞：无

---

## 任务统计

DeliverOrderBundle 的任务分解已完成。

任务统计：
- 基础架构：2 个任务（任务 1-2）
- 实体和数据模型：3 个任务（任务 3-5）
- Repository：1 个任务（任务 6）
- 接口定义：2 个任务（任务 7-8）
- 核心实现：4 个任务（任务 9-12）
- 事件系统：2 个任务（任务 13-14）
- 配置和集成：2 个任务（任务 15-16）
- 扩展机制：2 个任务（任务 17-18）
- 测试和文档：2 个任务（任务 19-20）

所有任务都包含 TDD 步骤和测试场景。准备开始实施吗？

## 实施建议

1. **第一阶段**（基础）：任务 1-8
   - 建立包的基础结构
   - 定义所有接口和数据模型
   
2. **第二阶段**（核心）：任务 9-14
   - 实现核心业务逻辑
   - 完成事件系统
   
3. **第三阶段**（集成）：任务 15-18
   - 配置 Symfony 集成
   - 实现扩展机制
   
4. **第四阶段**（完善）：任务 19-20
   - 完成测试套件
   - 编写文档

每个任务预计需要 2-4 小时完成，总工期约 40-80 小时。