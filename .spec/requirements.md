# DeliverOrderBundle 需求规范

## 1. 概述

### 1.1 包的目的
DeliverOrderBundle 是一个独立的发货单管理包，提供发货单的核心功能实现。通过将发货单从订单核心包（OrderCoreBundle）中拆分出来，实现发货单功能的解耦和复用，支持多种业务场景（如订单发货、售后换货等）的发货操作。

### 1.2 价值主张
- **解耦性**：将发货单从订单系统中独立出来，降低模块间的耦合度
- **复用性**：支持多种业务场景的发货需求（订单发货、售后换货、补发等）
- **扩展性**：提供灵活的扩展机制，支持不同业务系统的集成
- **标准化**：建立统一的发货流程和数据模型

### 1.3 主要使用者
- 订单管理系统开发者
- 售后服务系统开发者
- 仓储物流系统集成开发者
- 电商平台开发者

## 2. 功能需求

### 2.1 核心实体管理

#### 2.1.1 发货单（DeliverOrder）
- **普遍性**：系统必须提供 `DeliverOrder` 实体来管理发货单信息
- **普遍性**：系统必须支持发货单号的唯一性生成（雪花ID，前缀"D"）
- **普遍性**：系统必须记录发货单的快递信息（快递公司、快递单号、快递编码）
- **普遍性**：系统必须记录收货人信息（姓名、电话、地址、备注）
- **状态驱动**：当处于已发货状态时，系统必须记录发货时间和发货操作人
- **状态驱动**：当处于已收货状态时，系统必须记录收货时间和收货用户
- **状态驱动**：当处于已拒收状态时，系统必须记录拒收时间、拒收原因和拒收用户

#### 2.1.2 发货明细（DeliverStock）
- **普遍性**：系统必须提供 `DeliverStock` 实体来管理发货明细
- **普遍性**：系统必须支持记录SKU信息、数量、序列号等
- **事件驱动**：当创建发货明细时，系统必须验证SKU的有效性
- **条件性**：如果启用批次管理，系统必须记录批次信息
- **条件性**：如果启用序列号管理，系统必须记录产品序列号

### 2.2 发货单来源管理

#### 2.2.1 来源接口定义
- **普遍性**：系统必须提供 `DeliverSourceInterface` 接口定义发货单来源
- **普遍性**：系统必须支持多种来源类型（订单、售后单、补发单等）
- **事件驱动**：当创建发货单时，系统必须记录来源类型和来源ID
- **可选性**：在配置启用的情况下，系统必须验证来源的有效性

#### 2.2.2 来源上下文
- **普遍性**：系统必须提供 `DeliverContext` 类管理发货上下文
- **普遍性**：系统必须在上下文中保存来源信息、业务数据等
- **条件性**：如果来源是订单，系统必须验证订单状态允许发货
- **条件性**：如果来源是售后单，系统必须验证售后状态允许换货

### 2.3 业务流程管理

#### 2.3.1 发货流程
- **事件驱动**：当触发发货操作时，系统必须创建发货单
- **事件驱动**：当发货单创建时，系统必须触发 `DeliverOrderCreatedEvent` 事件
- **普遍性**：系统必须支持部分发货和完全发货
- **条件性**：如果配置了库存管理，系统必须扣减库存
- **条件性**：如果配置了物流对接，系统必须调用物流API创建运单

#### 2.3.2 收货流程
- **事件驱动**：当确认收货时，系统必须更新发货单状态为已收货
- **事件驱动**：当收货完成时，系统必须触发 `DeliverOrderReceivedEvent` 事件
- **可选性**：在启用签收凭证的情况下，系统必须记录签收图片或电子签名

#### 2.3.3 拒收流程
- **事件驱动**：当发生拒收时，系统必须更新发货单状态为已拒收
- **事件驱动**：当拒收发生时，系统必须触发 `DeliverOrderRejectedEvent` 事件
- **普遍性**：系统必须记录拒收原因
- **条件性**：如果配置了库存管理，系统必须恢复库存

### 2.4 API接口

#### 2.4.1 发货单管理接口
- **普遍性**：系统必须提供 `DeliverOrderServiceInterface` 服务接口
- **普遍性**：系统必须提供创建发货单的方法 `createDeliverOrder(DeliverContext $context): DeliverOrder`
- **普遍性**：系统必须提供查询发货单的方法 `findDeliverOrder(string $sn): ?DeliverOrder`
- **普遍性**：系统必须提供更新发货状态的方法 `updateStatus(DeliverOrder $order, string $status): void`

#### 2.4.2 事件接口
- **普遍性**：系统必须提供标准的事件接口供外部监听
- **普遍性**：系统必须支持事件订阅者扩展
- **可选性**：在启用异步处理的情况下，系统必须支持异步事件处理

### 2.5 扩展机制

#### 2.5.1 验证器扩展
- **普遍性**：系统必须提供 `DeliverValidatorInterface` 验证器接口
- **普遍性**：系统必须支持自定义验证规则
- **事件驱动**：当执行发货前，系统必须调用所有注册的验证器

#### 2.5.2 处理器扩展
- **普遍性**：系统必须提供 `DeliverProcessorInterface` 处理器接口
- **普遍性**：系统必须支持自定义业务处理逻辑
- **可选性**：在配置处理器链的情况下，系统必须按顺序执行处理器

## 3. 非功能需求

### 3.1 性能要求
- **普遍性**：系统必须支持批量创建发货单（单次最多100个）
- **普遍性**：系统必须在3秒内完成单个发货单的创建
- **条件性**：如果启用缓存，系统必须缓存常用查询结果

### 3.2 兼容性要求
- **普遍性**：系统必须支持 PHP 8.1 及以上版本
- **普遍性**：系统必须支持 Symfony 6.4 及以上版本
- **普遍性**：系统必须兼容 Doctrine ORM 3.0+
- **普遍性**：系统必须提供向后兼容的API

### 3.3 扩展性要求
- **普遍性**：系统必须提供清晰的扩展点
- **普遍性**：系统必须支持通过配置切换不同的实现
- **可选性**：在需要自定义字段的情况下，系统必须支持实体扩展

### 3.4 安全性要求
- **普遍性**：系统必须验证操作权限
- **普遍性**：系统必须记录所有关键操作的日志
- **条件性**：如果配置了数据加密，系统必须加密敏感信息

## 4. 集成需求

### 4.1 Symfony框架集成
- **普遍性**：系统必须提供标准的Symfony Bundle结构
- **普遍性**：系统必须支持Symfony的依赖注入容器
- **普遍性**：系统必须提供配置文件支持（YAML/PHP）
- **可选性**：在使用Symfony Messenger的情况下，系统必须支持消息队列

### 4.2 Doctrine集成
- **普遍性**：系统必须使用Doctrine ORM进行数据持久化
- **普遍性**：系统必须提供数据库迁移脚本
- **普遍性**：系统必须支持多数据库连接配置

### 4.3 第三方系统集成
- **可选性**：在配置物流接口的情况下，系统必须支持主流快递公司API
- **可选性**：在配置ERP对接的情况下，系统必须提供标准的数据交换格式
- **可选性**：在配置WebHook的情况下，系统必须支持事件推送

## 5. 配置需求

### 5.1 基础配置
```yaml
deliver_order:
  # 发货单号生成配置
  sn_generator:
    type: snowflake  # snowflake | uuid | custom
    prefix: 'D'
    
  # 验证配置
  validation:
    check_source: true  # 是否验证来源有效性
    check_stock: true   # 是否验证库存
    
  # 事件配置
  events:
    async: false  # 是否异步处理事件
    
  # 扩展配置
  extensions:
    validators: []     # 自定义验证器
    processors: []     # 自定义处理器
```

### 5.2 服务配置
- **普遍性**：系统必须允许通过配置文件覆盖默认服务
- **普遍性**：系统必须支持服务的装饰器模式
- **可选性**：在需要的情况下，系统必须支持服务的懒加载

## 6. 验收标准

### 6.1 测试覆盖
- **普遍性**：系统必须达到80%以上的单元测试覆盖率
- **普遍性**：系统必须提供完整的集成测试
- **普遍性**：系统必须通过PHPStan Level 8检查

### 6.2 文档要求
- **普遍性**：系统必须提供完整的API文档
- **普遍性**：系统必须提供使用示例和最佳实践
- **普遍性**：系统必须提供升级指南

### 6.3 质量标准
- **普遍性**：系统必须遵循PSR-12编码规范
- **普遍性**：系统必须通过PHP-CS-Fixer检查
- **普遍性**：系统必须无已知的安全漏洞

## 7. 依赖声明

### 7.1 必需依赖
- symfony/framework-bundle: ^6.4|^7.0
- doctrine/orm: ^3.0
- doctrine/doctrine-bundle: ^2.11
- symfony/validator: ^6.4|^7.0
- symfony/event-dispatcher: ^6.4|^7.0

### 7.2 可选依赖
- symfony/messenger: ^6.4|^7.0 (异步事件处理)
- symfony/cache: ^6.4|^7.0 (查询缓存)
- symfony/security-bundle: ^6.4|^7.0 (权限验证)

### 7.3 内部包依赖
- tourze/doctrine-snowflake-bundle (雪花ID生成)
- tourze/doctrine-timestamp-bundle (时间戳记录)
- tourze/doctrine-user-bundle (用户追踪)
- tourze/doctrine-ip-bundle (IP追踪)

## 8. 风险和约束

### 8.1 技术风险
- 与现有OrderCoreBundle的迁移兼容性
- 多来源场景下的数据一致性保证
- 高并发下的发货单号唯一性保证

### 8.2 业务约束
- 必须保持与现有业务流程的兼容性
- 必须支持历史数据的迁移
- 必须考虑不同行业的发货特性差异

### 8.3 实施建议
- 分阶段实施：先实现核心功能，再添加扩展特性
- 提供迁移工具：协助从OrderCoreBundle迁移到独立包
- 保留兼容层：在过渡期提供向后兼容的API